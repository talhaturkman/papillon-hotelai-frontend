steps:
  # Install Node.js and dependencies
  - name: 'node:18-slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Installing dependencies..."
        npm install
        ls -la
        ls -la server/
        
  # Build the container image manually
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/papillon-backend'
      - '--build-arg'
      - 'NODE_ENV=production'
      - '-f'
      - 'server/Dockerfile.simple'
      - '.'
      
  # Push the container image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/papillon-backend']
  
  # Deploy container image to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
    - 'run'
    - 'deploy'
    - 'papillon-backend'
    - '--image'
    - 'gcr.io/$PROJECT_ID/papillon-backend'
    - '--region'
    - 'us-central1'
    - '--platform'
    - 'managed'
    - '--port'
    - '8080'
    - '--allow-unauthenticated'
    - '--set-env-vars'
    - 'NODE_ENV=production,GOOGLE_CLOUD_API_KEY=${_GOOGLE_CLOUD_API_KEY},FIREBASE_PROJECT_ID=${_FIREBASE_PROJECT_ID},GEMINI_MODEL=${_GEMINI_MODEL}'

substitutions:
  _GOOGLE_CLOUD_API_KEY: 'AIzaSyBiqxFAooCoJX1y-_IgDbVAtoaZ2SVKmxk'
  _FIREBASE_PROJECT_ID: 'gen-lang-client-0930707875'
  _GEMINI_MODEL: 'gemini-2.0-flash-exp'

options:
  logging: CLOUD_LOGGING_ONLY 